<!--
  Copyright 2018, Bart Butenaers
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/javascript">
    RED.nodes.registerType('ui-video',{
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},
            height: {value: 0},
            name: {value: ''},
            imageField: {value: "image"},
            url: {value: ''},
            source: {value: "fetch"},
            font: {value: "Arial"},
            fontSize: {value: 12},
            area11: {value: ''},
            area12: {value: ''},
            area13: {value: ''},
            area21: {value: ''},
            area22: {value: ''},
            area23: {value: ''},
            area31: {value: ''},
            area32: {value: ''},
            area33: {value: ''},
        },
        inputs:1,
        outputs:1,
        icon: "cog.png",
        paletteLabel:"camera widget",
        label: function() {
            return this.name || "camera widget";
        },
        oneditprepare: function() {
            var components = [
                {v:"fps" , t:"FPS"},
                {v:"res" , t:"Resolution"},
                {v:"pt"  , t:"Pan/Tilt"},
                {v:"zoom", t:"Zoom"},
                {v:"stat", t:"Status"},
                {v:"name", t:"Name"},
            ];
            // Fill every area dropdown in the layout with the available components
            for (var row = 1; row <= 3; row++) {
                for (var column = 1; column <= 3; column++) {
                    for (var i = 0; i < components.length; i++) {
                        var elementId = "#node-input-area" + row + column;
                        var value = components[i].v;
                        var text = components[i].t;
                        $(elementId).append($("<option></option>").attr("value", value).text(text));
                    }
         
                    // Make sure the selected value is also selected in the <select> tag
                    $(elementId).val(this["area" + row + column]);
                }
            }
            
            // Show for every source type only the relevant input fields
            $("#node-input-source").change(function() {
                var source = $("#node-input-source").val();
                
                if (source === "fetch") {
                    $(".node-input-source-fetch").show();
                    $(".node-input-source-push").hide();
                }
                else {
                    $(".node-input-source-push").show();
                    $(".node-input-source-fetch").hide();
                }
            });
            
            // Show the imageField value in a typedinput element (dropdown with only 'msg')
            var value = $("#node-input-imageField").val() || 'payload';
            $("#node-input-typed-imageField").typedInput({types:['msg']});
            $("#node-input-typed-imageField").typedInput('type','msg');
            $("#node-input-typed-imageField").typedInput('value',value);
        
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
        },
        oneditsave: function() {
            // Copy the imageField value from the typedinput element to the imageField element
            var value = $("#node-input-typed-imageField").typedInput('value');
            $("#node-input-imageField").val(value);
        }
    });
</script>

<script type="text/x-red" data-template-name="ui-video">
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</span></label>
        <input type="text" id="node-input-group">
    </div>    
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> Size</span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    </br>
    <div class="form-row">
        <label for="node-input-source"><i class="fa fa-clock-o"></i> Source</label>
        <select id="node-input-source">
            <option value="fetch">URL (fetch)</option>
            <option value="push">Message (push)</option>
        </select>
    </div>
    <div class="form-row node-input-source-fetch">
        <label for="node-input-url"><i class="fa fa-globe"></i> URL</label>
        <input id="node-input-url" type="text" placeholder="http://">
    </div>
    <div class="form-row node-input-source-push">
        <label for="node-input-typed-imageField"><i class="fa fa-list"></i> Image field</label>
        <input id="node-input-typed-imageField" type="text" style="width: 70%">
        <input id="node-input-imageField" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-layout" style="vertical-align: top"><i class="fa fa-table"></i> Layout</label>
        <div id="node-input-layout" style="display:inline-block; width:67%; background-color:lightgrey;border-radius: 5px; padding: 5px; border: 3px solid #ccc;">    
            <div>
                <select id="node-input-area11" style="width:32%;"></select>
                <select id="node-input-area12" style="width:32%;"></select>
                <select id="node-input-area13" style="width:32%;"></select>
            </div>
            <div>
                <select id="node-input-area21" style="width:32%;"></select>
                <select id="node-input-area22" style="width:32%;"></select>
                <select id="node-input-area23" style="width:32%;"></select>
            </div>
            <div>
                <select id="node-input-area31" style="width:32%;"></select>
                <select id="node-input-area32" style="width:32%;"></select>
                <select id="node-input-area33" style="width:32%;"></select>
            </div>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-font"><i class="fa fa-clock-o"></i> Font</label>
        <select id="node-input-font" style="width:120px;">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Times">Times</option>
            <option value="Courier New">Courier New</option>
            <option value="Courier">Courier</option>            
            <option value="Verdana">Verdana</option>
            <option value="Georgia">Georgia</option>
            <option value="Palatino">Palatino</option>
            <option value="Garamond">Garamond</option>
            <option value="Bookman">Bookman</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
            <option value="Trebuchet MS">Trebuchet MS</option>
            <option value="Arial Black">Arial Black</option>
            <option value="Impact">Impact</option>
        </select>
        <input type="number" id="node-input-fontSize" style="width:80px;">
        <label>px</label>
    </div>
    </br>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<script type="text/x-red" data-help-name="ui-video">
    <p>A Node-RED widget node to show camera footage in the dashboard.</p>
</script>
